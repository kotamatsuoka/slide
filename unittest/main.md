# ユニットテストを書いて健康的に開発しよう

---

テスト書いていますか？

---

## もくじ
- ユニットテストとは
- 「健康的に開発する」とはどういうことか

---

## ユニットテストとは

ユニットテスト(単体テスト）は、プログラムを構成する比較的小さな単位（ユニット）が個々の機能を正しく果たしているかどうかを検証するテスト。

### テストの種類

- 機能単位: ユニットテスト
- 複数機能: インテグレーションテスト
- システム全体: E2E テスト

---

## 「健康的に開発する」とはどういうことか

1. 設計方針のズレによる手戻りで **時間・労力の無駄遣いを減らす**
2. プロダクトコードを**安心して**本番環境へ送り出せる
3. 自分が書いたコードに**自信が持てる**

<!--
健康的とは、時間を無駄にしなかったり、精神を疲弊しなかったり、あとは朝起きて、昨日の続きの開発がしたくなるようなコードを書いていくことだったりにおいて、僕はこの言葉を使っています。
テストは目的ではなくて、自分たちが健康に開発するための手段であることを忘れないようにしてほしい。
...
実際に、テストをどうやって使えば、これらの項目を実現できるかを、説明していきます。
-->

---

1. **設計方針のズレによる手戻りで時間・労力の無駄遣いを減らす**

2. プロダクトコードを安心して本番環境へ送り出せる

3. 自分が書いたコードに自信が持てる

---

### 設計方針のズレによる手戻りで時間・労力の無駄遣いを減らす

<!--
開発段階で、具体的に起こりうる問題、
-->

- PR出してから設計方針のズレが発覚
- 期日間際に実装スコープの認識ズレが発覚

<!--
ユニットテストを使って、解決策としては
-->
<br>
→ プロダクトコードを実装する前にテストだけレビューしてもらい、実装方針を具体的にすり合わせる！

---

<img width="95%" alt="carbon.png (246.9 kB)" src="https://img.esa.io/uploads/production/attachments/11364/2020/06/21/29773/e612cb30-8014-4164-baca-dc4b07ad4390.png">

---

#### 依存関係にあるクラス・関数が実装されてないとテスト書けないじゃん！

---

### 【unittest.mock.MagicMock】

関数やクラスをモック化できる

### 【moto】

AWS Serviseをモックする際に、とても便利！

[Moto - Mock AWS Services](https://github.com/spulec/moto)

---

1. 設計方針のズレによる手戻りで時間・労力の無駄遣いを減らす
2. **プロダクトコードを安心して本番環境へ送り出せる**
3. 自分が書いたコードに自信が持てる

---

### プロダクトコードを安心して本番環境へ送り出せる

- 「DFの中にnullが入っていたらうまく処理できないかも」
- 「formのtextareaは日本語不可にしたけど、バリデーションで弾かれるかな」
- 「データに意図していない型が入ってきたら、異常終了してくれるかな」

<br>
→ 考え得るテストパターンを網羅的に書く！

---

#### いろんなパターンでユニットテストを書いたら、テスト関数が増えすぎるじゃん！

---

#### parametrizeを使って複数テストケースを効率的にテストする

<img width="50%" alt="carbon (6).png (201.8 kB)" src="https://img.esa.io/uploads/production/attachments/11364/2020/06/21/29773/72f3f8e6-fcc6-4b0f-91fd-aa7c419f1b77.png">

<small>※ 標準ライブラリのunittestでは、【subTest】で同じようなことができる</small>

---

#### pytest.raisesで異常系もテストする

<img width="65%" alt="carbon (7).png (107.1 kB)" src="https://img.esa.io/uploads/production/attachments/11364/2020/06/21/29773/daf62234-d6b4-46e2-8ffc-3dafdcc46161.png">

<small>※ 「Exception」を指定してしまうと意図していない例外を起こしていてもテストが通ってしまうため実際に起こる例外を指定する</small>

---

#### テストが書きづらい時は設計を疑おう

---

- 「テストしたいクラス内でデータ読み込みをしている」
- 「依存関係が複雑でモック化が難しい」

<br>
→ 設計が良くないことが多いので、再設計を検討しよう!

<!--
テストが書きづらいってことは、テスト対象のクラスや関数が使いづらいということ
もちろん使い回しができなくなる
テストしづらい状態になってしまうのは、プロダクトコードから書き始めているため
-->

---

1. 設計方針のズレによる手戻りで時間・労力の無駄遣いを減らす
2. プロダクトコードを安心して本番環境へ送り出せる
3. **自分が書いたコードに自信が持てる**

---

### 自分が書いたコードに自信が持てる

- 「とりあえず実装できたけど汚いコードになり他の人に見せられない」
- 「再設計したいが本番環境で動いているものを変更するのは怖い」

<br>
→ テストを書いて終了ではなく、テストがあることを利用して、再設計・リファクタリングして品質を上げよう！

---

残念なことに...
<br>
**テストを書いただけだとプロダクトコードの品質は上がらない**

---

テストを担保にして、正しく再設計・リファクタリングを行うことで品質は上がり、自信に繋がる

<img width="40%" alt="image.png (47.0 kB)" src="https://img.esa.io/uploads/production/attachments/11364/2020/06/21/29773/8a4e1ae1-1a53-4fce-9aea-ec9c5ed032f8.png">

<small>(出典: [t_wadaさん SlideShare](https://www.slideshare.net/t_wada?utm_campaign=profiletracking&utm_medium=sssite&utm_source=ssslideview))<small/>

---

#### 品質が良いコードってなに？

---

将来の変更に耐えられるコード

---

## 今日から健康的な開発ライフを送ろう

- テストファーストで大きな手戻りを減らそう
- 不安がなくなるように網羅的にテストをしよう
- 「Red -> Green -> Refactoring」を回そう

<!--
- ユニットテストを先にレビューしてもらうことで、大きな手戻りを減らそう
- ユニットテストでは、不安なテストケースはすべてテストしよう
- 仕様変更が起きたら、まず、テストコードから修正しよう
- テストを書くことに満足せず、コードの品質をあげるために、「Red -> Green -> Refactoring」のサイクルを回そう
-->

---

おまけ

---

## TDD

---

### TDDの流れ

1. テストを書く
2. 実行して **失敗** させる
3. テストが通るように実装する
4. テストを **成功** させる
5. テストを担保に **リファクタリング** する

---

### TDDの何がいいの？

動作するキレイなコードを短い時間で書ける

---

## 良いテストとは

テストについて書かれている有名な書籍『Clean Code』と『達人プログラマー』で定義されている。

---

### F.I.R.S.T (『Clean Code』)

- Fast(高速)
- Independent(独立)
- Repeatable(再現)
- self-Validating(自己検証可能性)
- Timely(適時性)

---

### A-TRIP (『達人プログラマー』)

- Automated(自動)
- Thorough(徹底)
- Repeatable(再現性)
- Independent(独立)
- Professional(専門的)

---

2つの本で共通している項目は、

- 「独立している」
- 「再現可能である」

---

## 参考資料:

- 『テスト駆動開発』
- [t_wadaさん SlideShare](https://www.slideshare.net/t_wada?utm_campaign=profiletracking&utm_medium=sssite&utm_source=ssslideview)

---

## おすすめイベント:
- [TDDBC](https://tddbc.connpass.com/event/181973/)

---

## ありがとうございました。

実際に書いてみよう！
